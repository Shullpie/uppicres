import asyncio
from functools import partial

from environs import Env
from aiogram import Bot, Dispatcher, F
from aiogram.types import Message, ContentType, FSInputFile
from aiogram.filters import Command
from model.inference import infernce
from PIL import Image
from run import OPTIONS


env = Env()
env.read_env()

bot = Bot(env('BOT_TOKEN'))
dp = Dispatcher()


@dp.message(Command(commands='start'))
async def start(message: Message):
    await message.answer('–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –±–æ—Ç, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–π –¥–ª—è —Ä–µ—Å—Ç–∞–≤—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ä—ã—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π. '
                         '–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã –≤–∞—à–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±—ã–ª–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ, —Ç–æ –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏—à–ª–∏—Ç–µ –µ–≥–æ –≤ —ç—Ç–æ—Ç —á–∞—Ç.\n\n'
                         '–í–∞—à–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—Ç—å —Å–ª–µ–¥—É—é—â–∏–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º:\n'
                         'üü¢ –†–∞–∑–º–µ—Ä —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ 256x256 –ø–∏–∫—Å–µ–ª–µ–π;\n'
                         'üü¢ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ PNG, JPEG –∏–ª–∏ BMP;\n'
                         'üü¢ –í–∞—à–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è, –∏–Ω–∞—á–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç '
                         '–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º.\n\n'
                         '‚ö°–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–±—Å–æ–ª—é—Ç–Ω–æ –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∏ –Ω–µ –∑–∞–π–º–µ—Ç –±–æ–ª—å—à–µ –¥–≤—É—Ö –º–∏–Ω—É—Ç.\n\n'
                         '‚ùó–í–∞—à–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤ –ø–∞–º—è—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞ —Ç–æ–ª—å–∫–æ –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏, '
                         '–∞ –ø–æ—Å–ª–µ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ç—Ä–µ—Ç—Å—è.')
    

@dp.message(Command(commands='help'))    
async def start(message: Message):
    await message.answer('–î–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –≤–∞—à–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±—ã–ª–æ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ, –æ–Ω–æ '
                         '–¥–æ–ª–∂–Ω–æ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—Ç—å —Å–ª–µ–¥—É—é—â–∏–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º:\n\n'
                         'üü¢ –†–∞–∑–º–µ—Ä —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ 256x256 –ø–∏–∫—Å–µ–ª–µ–π;\n'
                         'üü¢ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ PNG, JPEG –∏–ª–∏ BMP;\n'
                         'üü¢ –í–∞—à–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è, –∏–Ω–∞—á–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç '
                         '–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º.')


@dp.message(Command(commands='info'))    
async def start(message: Message):
    await message.answer('–Ø –±–æ—Ç, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–π –¥–ª—è —Ä–µ—Å—Ç–∞–≤—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ä—ã—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π. '
                         '–í–∞—à–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—Ç—å —Å–ª–µ–¥—É—é—â–∏–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º:\n\n'
                         'üü¢ –†–∞–∑–º–µ—Ä —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ 256x256 –ø–∏–∫—Å–µ–ª–µ–π;\n'
                         'üü¢ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ PNG, JPEG –∏–ª–∏ BMP;\n'
                         'üü¢ –í–∞—à–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è, –∏–Ω–∞—á–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç '
                         '–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º.\n\n'
                         '‚ö°–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–±—Å–æ–ª—é—Ç–Ω–æ –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∏ –Ω–µ –∑–∞–π–º–µ—Ç –±–æ–ª—å—à–µ –¥–≤—É—Ö –º–∏–Ω—É—Ç.\n\n'
                         '‚ùó–í–∞—à–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤ –ø–∞–º—è—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞ —Ç–æ–ª—å–∫–æ –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏, '
                         '–∞ –ø–æ—Å–ª–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ç—Ä–µ—Ç—Å—è.')

@dp.message(F.content_type == ContentType.PHOTO)
async def send_restored_message(message: Message):
    img_id = message.photo[-1].file_id
    img_file = await bot.get_file(file_id=img_id)
    await bot.download_file(img_file.file_path, r'logs\temp\user_img.png')

    img = Image.open(r'logs\temp\user_img.png').convert('RGB')
    img_shape = img.size
    if img_shape[0] >= 256 and img_shape[1] >= 256:
        loop = asyncio.get_event_loop()
        try:
            await message.answer('–†–µ—Å—Ç–∞–≤—Ä–∞—Ü–∏—è –Ω–∞—á–∞–ª—Å—å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–∂–∏–¥–∞–π—Ç–µ.')
            res = await loop.run_in_executor(None, partial(infernce, 
                                                           user_img=img, 
                                                           inference_options=OPTIONS, 
                                                           todo={'clr': 1}))
            if isinstance(res, str):
                await message.answer(res)
            else:
                res.save(r'logs\temp\user_img.png')
                photo = FSInputFile(r'logs\temp\user_img.png')
                await bot.send_photo(chat_id=message.from_user.id, 
                                     photo=photo, 
                                     caption='–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ.')
        except Exception as ex:
            print(ex)
            await message.answer('–ò–∑–≤–∏–Ω–∏—Ç–µ, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. \n'
                                 '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è–µ—Ç –ª–∏ –≤–∞—à–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è '
                                 '–Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º (/help) –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.')
    else:
        await message.answer('–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Ä–∞–∑–º–µ—Ä –≤–∞—à–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç. \n'
                             '–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ 256x256 –ø–∏–∫—Å–µ–ª–µ–π. –ü–æ–¥—Ä–æ–±–Ω–µ–µ: /help')


@dp.message()
async def message(message: Message):
    await message.answer('–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —è –Ω–µ –º–æ–≥—É –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. \n'
                         '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ—á–∏—Ç–∞–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–±–æ –º–Ω–µ: /info')


async def start():
    await dp.start_polling(bot)
